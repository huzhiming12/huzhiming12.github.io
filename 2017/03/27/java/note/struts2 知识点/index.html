<h1 id="struts2-知识点"><a href="#struts2-知识点" class="headerlink" title="struts2 知识点"></a>struts2 知识点</h1><h4 id="Struts2工作流程"><a href="#Struts2工作流程" class="headerlink" title="Struts2工作流程"></a>Struts2工作流程</h4><p><img src="/2017/03/27/java/note/struts2 知识点/pic10.png" alt="pic10"></p>
<ol>
<li>客户端创建一个指向servlet容器（Tomcat）的请求</li>
<li>这个请求会经过一系列的过滤器，如ActionContextCleanUp</li>
<li>接着会调用FilterDispatcher，FilterDispatcher询问ActionMapper是否要调用某个Action。FilterDispatcher是控制器的核心。</li>
<li>如果ActionMapper决定需要调用某个action，则FilterDispatcher就把请求的处理交给ActionProxy</li>
<li>ActionProxy同ConfigurationManager询问框架的配置文件，一般是从Struts.xml配置文件中读取，找到需要调用的类。</li>
<li>ActionProxy创建一个ActionInvocation实例</li>
<li>ActionInvocation实例使用命名模式来调用，在调用Action过程中，会涉及到相关的拦截器的调用。</li>
<li>一旦Action执行完毕，ActionInvocation负责根据Struts.xml中的配置找到对应的返回结果，返回结果通常是jsp或者其他模板，但是也可能是指向其他Action的链。</li>
<li>相应返回的结果通过我们的web.xml配置中的过滤器</li>
<li>如果ActionContextCleanUp是当前使用的，则FilterDispatecher将不会清理sreadlocal ActionContext;如果ActionContextCleanUp不使用，则将会去清理sreadlocals。</li>
</ol>
<h4 id="Interceptor拦截器"><a href="#Interceptor拦截器" class="headerlink" title="Interceptor拦截器"></a>Interceptor拦截器</h4><p>interceptor拦截器在容器启动时候完成初始化。注意：必须是Action引用了的interceptor才会被初始化，只定义但是Action没有引用的Interceptor是不会被初始化的。</p>
<p>拦截器的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">package</span> <span class="attr">name</span>=<span class="string">"front"</span> <span class="attr">namespace</span>=<span class="string">"/"</span> <span class="attr">extends</span>=<span class="string">"struts-default,json-default"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">interceptors</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">interceptor</span> <span class="attr">name</span>=<span class="string">"testInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.hzm.bbs.interceptor.TestInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">interceptor</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">interceptor</span> <span class="attr">name</span>=<span class="string">"loginInterceptor"</span> <span class="attr">class</span>=<span class="string">"com.hzm.bbs.interceptor.LoginInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">interceptor</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">interceptors</span>&gt;</span></div><div class="line"></div><div class="line">		<span class="tag">&lt;<span class="name">action</span> <span class="attr">name</span>=<span class="string">"User_*"</span> <span class="attr">class</span>=<span class="string">"com.hzm.bbs.action.UserAction"</span></span></div><div class="line">			<span class="attr">method</span>=<span class="string">"&#123;1&#125;"</span>&gt;</div><div class="line">			<span class="tag">&lt;<span class="name">result</span> <span class="attr">type</span>=<span class="string">"json"</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"root"</span>&gt;</span>jsonResult<span class="tag">&lt;/<span class="name">param</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">result</span>&gt;</span></div><div class="line">			<span class="comment">&lt;!-- 自定义拦截器 --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">"testInterceptor"</span>&gt;</span></div><div class="line">                <span class="comment">&lt;!--拦截器中定义参数--&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">param</span> <span class="attr">name</span>=<span class="string">"site"</span>&gt;</span>localhost:8080/test<span class="tag">&lt;/<span class="name">param</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">interceptor-ref</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">"loginInterceptor"</span>&gt;</span><span class="tag">&lt;/<span class="name">interceptor-ref</span>&gt;</span></div><div class="line">			<span class="comment">&lt;!--注意，每一个action都有一个默认的拦截器，如果指定了自定义的拦截器，那么默认的拦截器就失去作用了，所以这里要再加上默认的拦截器--&gt;</span> </div><div class="line">			<span class="tag">&lt;<span class="name">interceptor-ref</span> <span class="attr">name</span>=<span class="string">"defaultStack"</span>&gt;</span><span class="tag">&lt;/<span class="name">interceptor-ref</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">action</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">package</span>&gt;</span></div></pre></td></tr></table></figure>
<p>拦截器在包package下面声明拦截器，在action的result标签下面引用。</p>
<p>Interceptor样例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hzm.bbs.interceptor;</div><div class="line"></div><div class="line"><span class="keyword">import</span> com.opensymphony.xwork2.ActionInvocation;</div><div class="line"><span class="keyword">import</span> com.opensymphony.xwork2.interceptor.Interceptor;</div><div class="line"></div><div class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"serial"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginInterceptor</span> <span class="keyword">implements</span> <span class="title">Interceptor</span></span></div><div class="line">&#123;</div><div class="line">  	<span class="keyword">private</span> String site;<span class="comment">//拦截器中定义的参数</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getSite</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">return</span> site;</div><div class="line">	&#125;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSite</span><span class="params">(String site)</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="keyword">this</span>.site = site;</div><div class="line">	&#125;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		System.out.println(<span class="string">"LoginInterceptor destory!"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">()</span></span></div><div class="line">	&#123;	<span class="comment">//容器初始化的时候调用</span></div><div class="line">		System.out.println(<span class="string">"LoginInterceptor init!"</span>);</div><div class="line">      	System.out.println(<span class="string">"site:"</span> + getSite());<span class="comment">//调用拦截器中定义的参数</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">intercept</span><span class="params">(ActionInvocation invocation)</span> <span class="keyword">throws</span> Exception</span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		System.out.println(<span class="string">"before Action!"</span>);</div><div class="line">		String reString=invocation.invoke();<span class="comment">//要执行的action</span></div><div class="line">		System.out.println(<span class="string">"after Action!"</span>);</div><div class="line">		<span class="keyword">return</span> reString;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Filter过滤器"><a href="#Filter过滤器" class="headerlink" title="Filter过滤器"></a>Filter过滤器</h4><p>在请求web.xml时，检测URL是否符合某个过滤器，当符合时会先执行过滤器器中的doFilter()方法，在doFilter()方法中可以对用户信息进行校验，或者对请求参数等进行修改校验等。</p>
<p><em>注意</em>：过滤器是在拦截器之前执行，过滤器执行完毕后才进入拦截器中</p>
<p>在web.xml文件中配置过滤器</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">&lt;!--自定义过滤器 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>LoginFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>com.hzm.bbs.interceptor.LoginFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>LoginFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>自定义Filter：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.hzm.bbs.interceptor;</div><div class="line"></div><div class="line"><span class="keyword">import</span> java.io.IOException;</div><div class="line"><span class="keyword">import</span> javax.servlet.Filter;</div><div class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</div><div class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletException;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</div><div class="line"><span class="keyword">import</span> javax.servlet.http.HttpSession;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LoginFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span></span></div><div class="line">&#123;</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span></span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain chain)</span></span></div><div class="line">			<span class="keyword">throws</span> IOException, ServletException</div><div class="line">	&#123;</div><div class="line">		HttpServletRequest request2 = (HttpServletRequest) request;</div><div class="line">		HttpSession session = request2.getSession();</div><div class="line">      	<span class="comment">//判断用户是否登录</span></div><div class="line">		<span class="keyword">if</span> (session.getAttribute(<span class="string">"user"</span>) == <span class="keyword">null</span>)</div><div class="line">			System.out.println(<span class="string">"用户还未登录"</span>);</div><div class="line">		<span class="keyword">else</span>	<span class="comment">//已登录则放行</span></div><div class="line">			chain.doFilter(request, response);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig arg0)</span> <span class="keyword">throws</span> ServletException</span></div><div class="line">	&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>chain.doFilter(request,response):作用是将请求转发给过滤器链上下一个对象,这里的下一个对象指的是下一个filter，如果没有filter那就是你请求的资源。</p>
<p>一般filter都是一个链,web.xml 里面配置了几个就有几个。一个一个的连在一起 </p>
<p>request -&gt; filter1 -&gt; filter2 -&gt;filter3 -&gt; …. -&gt; request resource.</p>
<h4 id="拦截器与过滤器的区别"><a href="#拦截器与过滤器的区别" class="headerlink" title="拦截器与过滤器的区别"></a>拦截器与过滤器的区别</h4><ul>
<li>拦截器是基于Java反射机制，而过滤器只是函数回调</li>
<li>拦截器只有在请求action的时候才会调用，而过滤器任何请求都可以调用</li>
<li>拦截器不依赖于servlet容器，而过滤器依赖于servlet容器</li>
<li>拦截器可以访问action上下文、值栈里的对象，而过滤器不能</li>
</ul>
